"use strict";var Ninja=function(e){var t=this;this.Options={accessToken:undefined,userAccessToken:undefined,server:"https://a.ninja.is",streamServer:"https://stream.ninja.is",version:0,debug:!1},this.ServerUrl=function(){var e=this.Options.server+"/rest/v"+this.Options.version;return e},this.StreamServerUrl=function(){var e=this.Options.streamServer+"/rest/v"+this.Options.version;return e};var n=function(){var e=t;this.getAuthSlug=function(t){var n=t?"&":"?",r=this.GetMode();switch(r){case Ninja.AuthenticationModes.ACCESS_TOKEN:return n+"access_token="+e.Options.accessToken;case Ninja.AuthenticationModes.USER_ACCESS_TOKEN:return n+"user_access_token="+e.Options.userAccessToken;case Ninja.AuthenticationModes.SESSION:return"";default:return""}},this.GetMode=function(){return e.Options[Ninja.AuthenticationModes.ACCESS_TOKEN]?Ninja.AuthenticationModes.ACCESS_TOKEN:e.Options[Ninja.AuthenticationModes.USER_ACCESS_TOKEN]?Ninja.AuthenticationModes.USER_ACCESS_TOKEN:Ninja.AuthenticationModes.SESSION}},r=function(e){var n=t;this.Options={},this.Options=Ninja.Utilities.ObjectMerge(this.Options,e),this.GetInfo=function(e){var t=n.ServerUrl()+"/user"+n.Authentication.getAuthSlug(),r=Ninja.Utilities.CreateXHR(function(t){e&&e(t)},this);return r.open("GET",t,!0),r.setRequestHeader("Accept","application/json"),r.send(),!0};var r=function(e){n.Options.debug&&console.log(e)};this.GetStream=function(e){var t=n.ServerUrl()+"/user/stream"+n.Authentication.getAuthSlug(),r=Ninja.Utilities.CreateXHR(function(t){e&&e(t)},this);return r.open("GET",t,!0),r.setRequestHeader("Accept","application/json"),r.send(),!0},this.GetPusherChannel=function(e){var t=n.ServerUrl()+"/user/pusherchannel"+n.Authentication.getAuthSlug(),r=Ninja.Utilities.CreateXHR(function(t){t.result&&e&&e(t)});return r.open("GET",t,!0),r.setRequestHeader("Accept","application/json"),r.send(),!0},this.GetPreferences=function(e){var t=n.ServerUrl()+"/user/preferences"+n.Authentication.getAuthSlug(),r=Ninja.Utilities.CreateXHR(function(t){t.result&&e&&e(t.data)});return r.open("GET",t,!0),r.setRequestHeader("Accept","application/json"),r.send(),!0},this.SetPreferences=function(e,t){var r=n.ServerUrl()+"/user/preferences"+n.Authentication.getAuthSlug(),i=Ninja.Utilities.CreateXHR(function(e){e.result?t&&t(!0):t&&t(!1)});return i.open("PUT",r,!0),i.setRequestHeader("Accept","application/json"),i.setRequestHeader("Content-Type","application/json"),i.send(JSON.stringify(e)),!0},this.GetBlocks=function(e){n.Options.debug&&console.log("GetBlocks");var t=n.ServerUrl()+"/blocks"+n.Authentication.getAuthSlug(),r=Ninja.Utilities.CreateXHR(function(t){if(t.result){var r=n.API.ParseBlocks(t.data);e&&e(r)}});r.open("GET",t,!0),r.setRequestHeader("Accept","application/json"),r.send()},this.GetDevices=function(e){n.Options.debug&&console.log("GetDevices ");var t=n.ServerUrl()+"/devices"+n.Authentication.getAuthSlug(),r=Ninja.Utilities.CreateXHR(function(t){if(t.result){var r=n.API.ParseDevices(t.data);e&&e(r)}},this);r.open("GET",t,!0),r.setRequestHeader("Accept","application/json"),r.send()},this.CreateService=function(e,t){var r=n.ServerUrl()+"/service/"+e+n.Authentication.getAuthSlug(),i=Ninja.Utilities.CreateXHR(function(e){if(e.result){var r=e.data;n.API.GetDeviceByGuid(r.GUID,function(e){var r={};r[e.guid]=e;var i=n.API.ParseDevices(r);t&&t(i.devices[0],i.blocks[0])})}});i.open("PUT",r,!0),i.setRequestHeader("Accept","application/json"),i.send()}},i=function(){var e=t;this.GetDeviceByGuid=function(t,n){var r=e.ServerUrl()+"/device/"+t+e.Authentication.getAuthSlug(),i=Ninja.Utilities.CreateXHR(function(e){e.result&&n&&n(e.data)});i.open("GET",r,!0),i.setRequestHeader("Accept","application/json"),i.send()},this.ParseBlocks=function(t){var n=[];for(var r in t)if(t.hasOwnProperty(r)){var i=t[r],s=new e.Block({nodeId:r});n.push(s)}return n},this.ParseDevices=function(t){var n=[],r=[],i=function(t){var n;for(var i=0;i<r.length;i++){var s=r[i];s.Options.nodeId===t&&(n=s)}return n===undefined&&(n=new e.Block({nodeId:t}),r.push(n)),n};for(var s in t)if(t.hasOwnProperty(s)){var o=t[s],u=Ninja.Utilities.SplitGUID(s),a=i(u.nodeId),f=new e.Device({deviceId:u.deviceId,type:o.device_type,name:o.shortName,vendor:o.vid,port:o.gid,rawData:o});a.RegisterDevice(f);for(var l in o.subDevices){var c=new e.Subdevice(o.subDevices[l]);c.Id=l,f.Options.subdevices.push(c)}n.push(f)}return{blocks:r,devices:n}}};this.Block=function(e){var n=t,r,i,s=0;this.Devices=[],this.Options={nodeId:undefined,token:undefined,listenInterval:300},this.Options=Ninja.Utilities.ObjectMerge(this.Options,e),this.Claim=function(e){var t={nodeid:this.Options.nodeId},r=n.ServerUrl()+"/block"+n.Authentication.getAuthSlug(),i=Ninja.Utilities.CreateXHR(function(t){t.result?e&&e(!0):e&&e(!1)},this);i.open("POST",r,!0),i.setRequestHeader("Content-Type","application/json"),i.send(JSON.stringify(t))},this.Activate=function(e){function u(){}var t={nodeid:this.Options.nodeId},r=n.ServerUrl()+"/block/"+this.Options.nodeId+"/activate",i,s=Ninja.Utilities.CreateXHR(function(t){this.Options.token=t.token,e&&e(t.token)},this);s.open("GET",r,!0),xhr.setRequestHeader("Accept","application/json"),s.send();var o=function(){s=undefined,clearInterval(i),this.Activate()}},this.ConfirmActivation=function(e){var t={token:this.Options.token},r=n.ServerUrl()+"/block/"+this.Options.nodeId+"/activate",i=Ninja.Utilities.CreateXHR(function(t){t.result&&e&&e(t.token)});i.open("POST",r,!0),xhr.setRequestHeader("Accept","application/json"),i.send(JSON.stringify(t))},this.Unpair=function(e){var t=n.ServerUrl()+"/block/"+this.Options.nodeId+n.Authentication.getAuthSlug(),r=Ninja.Utilities.CreateXHR(function(t){t.result&&e&&e(t.data)});r.open("DELETE",t,!0),r.setRequestHeader("Accept","application/json"),r.send()},this.HeartBeat=function(e){},this.IsListening=function(){return r!==undefined&&i!==undefined&&i.readyState===3},this.ParseCommands=function(){if(i&&i.readyState===4){var e=i.responseText.length;if(s===e&&s!==0)return;var t=i.responseText.substring(s,e);s=e;var n=t.split("\n");for(var r=0;r<n.length;r++){var o=n[r];if(o!==""){var u=JSON.parse(o);this.BroadcastCommand(u)}}this.Stop(),this.Listen()}},this.ListenErrorHandler=function(){this.Stop(),this.Listen()},this.Listen=function(e){if(this.Options.token===undefined)return!1;var t=n.ServerUrl()+"/block/"+this.Options.nodeId+"/commands";if(!i){try{i=Ninja.Utilities.CreateXHR(this.ParseCommands,this),i.open("GET",t,!0),i.setRequestHeader("X-Ninja-Token",this.Options.token),i.addEventListener("error",this.ListenErrorHandler.bind(this),!1),i.addEventListener("abort",this.ListenErrorHandler.bind(this),!1),i.addEventListener("load",this.ParseCommands.bind(this),!1),i.send()}catch(r){return!1}return!0}return!1},this.Stop=function(){return s=0,i=undefined,clearInterval(r),r=undefined,!0},this.BroadcastCommand=function(e){if(e.DEVICE){var t=e.DEVICE;for(var n=0;n<t.length;n++){var r=t[n],i=this.GetDeviceByPortVendorDeviceID(r.G,r.V,r.D);i.Actuate(r.DA)}}},this.RegisterDevice=function(e){e.Options.block=this,this.Devices.push(e)},this.GetDevices=function(){return this.Devices},this.GetDevicesByType=function(e){var t=[];for(var n=0;n<this.Devices.length;n++){var r=this.Devices[n];r.Options.type===e&&t.push(r)}return t},this.GetDevicesByDeviceId=function(e){var t=[];for(var n=0;n<this.Devices.length;n++){var r=this.Devices[n];r.Options.deviceId===e&&t.push(r)}return t},this.GetDeviceByPortVendorDeviceID=function(e,t,n){var r={};for(var i=0;i<this.Devices.length;i++){var s=this.Devices[i];s.Options.vendor===t&&s.Options.port==e.toString()&&s.Options.deviceId==n&&(r=s)}return r},this.GetDeviceByGuid=function(e){var t={};for(var n=0;n<this.Devices.length;n++){var r=this.Devices[n];r.GUID()===e&&(t=r)}return t}},this.Device=function(e){var n=t;this.GUID=function(){return this.Options.hasOwnProperty("guid")?this.Options.guid:this.Options.block?this.Options.block.Options.nodeId+"_"+this.Options.port+"_"+this.Options.vendor+"_"+this.Options.deviceId:"Not associated with a block. Please Register this device"};var r=function(){if(parseInt(this.Options.deviceId)===31||parseInt(this.Options.deviceId)===30){var e=this.Options.port.toString().substring(0,2),t=this.Options.port.toString().substring(2,4);this.Options.station=e,this.Options.channel=t}};this.AutoLoadData=function(){this.GetData(function(e){this.LoadData(e),this.Options.loadcallback&&this.Options.loadcallback()}.bind(this))},this.LoadData=function(e){var t=new n.Block({nodeId:e.node});this.Options.block=t,this.Options.rawData=e,this.Options.deviceId=parseInt(e.did,10),this.Options.vendor=parseInt(e.vid),this.Options.port=e.gid,this.Options.type=e.device_type,this.Options.name=e.default_name,e.last_data&&e.last_data.hasOwnProperty("DA")&&(this.Options.value=e.last_data.DA)},this.Emit=function(e,t){var r=n.ServerUrl()+"/device/"+this.GUID()+n.Authentication.getAuthSlug();e={DA:e};var i=Ninja.Utilities.CreateXHR(function(e){t&&t(e)},this);return i.open("PUT",r,!0),i.setRequestHeader("Accept","application/json"),i.setRequestHeader("Content-Type","application/json"),i.send(JSON.stringify(e)),!0},this.Options={name:"",type:Ninja.DeviceTypes.UNDEFINED,deviceId:0,vendor:0,port:0,block:undefined,value:undefined,subdevices:[],onActuate:function(){throw".onActuate() not implemented."}},this.on=function(e,t){},this.Delete=function(e){var t=n.ServerUrl()+"/device/"+this.GUID()+n.Authentication.getAuthSlug(),r=Ninja.Utilities.CreateXHR(function(t){e&&e(t)},this);r.open("DELETE",t,!0),r.setRequestHeader("Accept","application/json"),r.send()},this.GetHistoricalData=function(e,t){var r=Ninja.Utilities.ObjectToQueryString(e),i=n.ServerUrl()+"/device/"+this.GUID()+"/data?"+r+n.Authentication.getAuthSlug(r.length>0),s=Ninja.Utilities.CreateXHR(function(e){e.result&&t&&t(e.data)});s.open("GET",i,!0),s.setRequestHeader("Accept","application/json"),s.send()},this.GetData=function(e){var t=n.ServerUrl()+"/device/"+this.GUID()+n.Authentication.getAuthSlug(),r=Ninja.Utilities.CreateXHR(function(t){t.result&&e&&e(t.data)},this);r.open("GET",t,!0),r.setRequestHeader("Accept","application/json"),r.send()},this.GetCallback=function(e){var t=n.ServerUrl()+"/device/"+this.GUID()+"/callback"+n.Authentication.getAuthSlug(),r=Ninja.Utilities.CreateXHR(function(t){t.result&&e&&e(t.data)});r.open("GET",t,!0),r.setRequestHeader("Accept","application/json"),r.send()},this.SetCallback=function(e,t){var r=n.ServerUrl()+"/device/"+this.GUID()+"/callback"+n.Authentication.getAuthSlug(),i=Ninja.Utilities.CreateXHR(function(e){e.result&&t&&t()});if(e!==null){var s={url:e};i.open("POST",r,!0),i.setRequestHeader("Content-Type","application/json"),i.send(JSON.stringify(s))}else i.open("DELETE",r,!0),i.setRequestHeader("Accept","application/json"),i.send()},this.Rename=function(e,t){var r={shortName:e},i=n.ServerUrl()+"/device/"+this.GUID()+n.Authentication.getAuthSlug(),s=Ninja.Utilities.CreateXHR(function(e){e.result&&t&&t()});s.open("PUT",i,!0),s.setRequestHeader("Accept","application/json"),s.setRequestHeader("Content-Type","application/json"),s.send(JSON.stringify(r))},this.SetSubdevice=function(e,t){if(!(e instanceof n.Subdevice))return!1;var r,i;e.Id?(r=n.ServerUrl()+"/device/"+this.GUID()+"/subdevice/"+e.Id+n.Authentication.getAuthSlug(),i=Ninja.Utilities.CreateXHR(function(e){e.result?t&&t(!0):t&&t(!1)}),i.open("PUT",r,!0)):(r=n.ServerUrl()+"/device/"+this.GUID()+"/subdevice"+n.Authentication.getAuthSlug(),i=Ninja.Utilities.CreateXHR(function(n){n.result?t&&(e.Id=n.data.id,t(n.data)):t&&t(!1)}),i.open("POST",r,!0)),i.setRequestHeader("Content-Type","application/json"),i.setRequestHeader("Accept","application/json"),i.send(JSON.stringify(e.Options))},this.GetSubdeviceById=function(e,t){var n;for(var r in this.Options.subdevices){var i=this.Options.subdevices[r];if(r.Id==e){n=i;break}}return n},this.DeleteSubdevice=function(e,t){if(e instanceof n.Subdevice){if(!e.Id)return t&&t(!1),!1;var r=n.ServerUrl()+"/device/"+this.GUID()+"/subdevice/"+e.Id+n.Authentication.getAuthSlug(),i=Ninja.Utilities.CreateXHR(function(n){var r=this.Options.subdevices.indexOf(e);this.Options.subdevices.splice(r,1),t&&t(n.result?!0:!1)}.bind(this));i.open("DELETE",r,!0),i.setRequestHeader("Accept","application/json"),i.send()}},this.HasMetaData=function(){return Ninja.Utilities.ObjectIsDefined(this.GetMetaData())},this.GetMetaData=function(){return this.Options.rawData&&this.Options.rawData.meta?this.Options.rawData.meta:{}},this.Options=Ninja.Utilities.ObjectMerge(this.Options,e),this.Actuate=this.Options.onActuate,r.bind(this)(),this.Options.hasOwnProperty("guid")&&this.AutoLoadData()},this.Subdevice=function(e){var n=t;this.Id=null,this.Options={category:"",shortName:"",data:null,type:null};var r=function(e){switch(e.Options.category){case Ninja.SubdeviceCategories.RF:break;case Ninja.SubdeviceCategories.WEBHOOK:break;case Ninja.SubdeviceCategories.SMS:}},i=function(e){return e.Options.category===""?!1:e.Options.type===null||e.Options.type===""||e.Options.type===undefined?!1:!0};this.Options=Ninja.Utilities.ObjectMerge(this.Options,e);if(!i(this))return this;r(this)},this.App=function(e){var n=t,r=null;this.Options={name:"",redirectUri:null,secret:null},this.Save=function(e){var t,r={name:this.Options.name,redirect_uri:this.Options.redirectUri},s;this.Id?(s="PUT",r.id=this.Id,t=n.ServerUrl()+"/app/"+this.Id+n.Authentication.getAuthSlug()):(s="POST",t=n.ServerUrl()+"/app"+n.Authentication.getAuthSlug());var o=Ninja.Utilities.CreateXHR(function(t){t.result&&(i(t.data),e&&e(t.data))});o.open(s,t,!0),o.setRequestHeader("Content-Type","application/json"),o.setRequestHeader("Accept","application/json"),o.send(JSON.stringify(r))};var i=function(e){this.Id=e.id?e.id:null,this.Options.secret=e.secret?e.secret:null};this.Delete=function(){var e=n.ServerUrl()+"/app/"+this.Id+n.Authentication.getAuthSlug(),t=Ninja.Utilities.CreateXHR(function(e){});t.open("DELETE",e,!0),t.setRequestHeader("Accept","application/json"),t.send()},this.Options=Ninja.Utilities.ObjectMerge(this.Options,e)},this.Authentication=new n,this.API=new i,this.Options=Ninja.Utilities.ObjectMerge(this.Options,e),this.User=new r};Ninja.AuthenticationModes={USER_ACCESS_TOKEN:"userAccessToken",ACCESS_TOKEN:"accessToken",SESSION:"session"},Ninja.DeviceTypes={UNDEFINED:"undefined",BUTTON:"button",RGBLED:"rgbled",TEMPERATURE:"temperature",HUMIDITY:"humidity",RF433:"rf433",MOTION:"motion",DISTANCE:"distance",WEBSERVICE:"webservice",ORIENTATION:"orientation",LOCATION:"location",ACCELERATION:"acceleration",PROXIMITY:"proximity",SOUND:"sound",WEBCAM:"webcam",EMAIL:"email",TWILIO:"twilio",SMS:"sms",WEBHOOK:"webhook",FACEBOOK:"facebook",TWITTER:"twitter",NETWORK:"network",RELAY:"relay"},Ninja.DeviceModes={ACTUATOR:"actuator",SENSOR:"sensor"},Ninja.DeviceDataFunctions={MEAN:"mean",SUM:"sum",MINIMUM:"min",MAXIMUM:"max",STDDEV:"stddev",SUMSQ:"ss",COUNT:"count"},Ninja.DeviceDataIntervals={MINUTE:"min",HOUR:"hour",DAY:"day",MONTH:"month",YEAR:"year"},Ninja.SubdeviceCategories={EMAIL:"email",RF:"rf",WEBHOOK:"webhook",SMS:"sms"},Ninja.SubdeviceTypes={ACTUATOR:"actuator",SENSOR:"sensor"},Ninja.Utilities={ObjectMerge:function(e,t){for(var n in t)try{t[n].constructor==Object?e[n]=this.ObjectMerge(e[n],t[n]):e[n]=t[n]}catch(r){e[n]=t[n]}return e},ObjectToQueryString:function(e){var t="",n=[];for(var r in e)try{r&&e[r]&&(t=r+"="+e[r],n.push(t))}catch(i){}return n.join("&")},ObjectArrayToArray:function(e,t){var n=[];t||(t="id");for(var r in e)if(e.hasOwnProperty(r)){var i=e[r];i[t]=r,n.push(i)}return n},ObjectIsDefined:function(e){var t=!1;for(var n in e)try{n&&e[n]&&(t=!0)}catch(r){t=!1}return t},CreateXHR:function(e,t){var n;if(window.ActiveXObject)try{n=new ActiveXObject("Microsoft.XMLHTTP")}catch(r){n=null}else n=new XMLHttpRequest;return n.onreadystatechange=function(r){n.readyState===4&&n.responseText&&(e&&t?e.call(t,JSON.parse(n.responseText)):e&&e(JSON.parse(n.responseText)))},n},SplitGUID:function(e){var t=e.split("_"),n=t[0],r=t[1],i=t[2],s=t[3];return{nodeId:n,port:r,vendor:i,deviceId:s}}},Ninja.Result=function(e){var t=!1,n="",r,i;return arguments.length===3?(t=arguments[0],n=arguments[1],r=arguments[2]):arguments.length===2?(t=arguments[0],t?r=arguments[1]:n=arguments[1]):arguments.length===1&&(e.result&&(t=e.result),e.message&&(n=e.message),e.payload&&(r=e.payload)),i={result:t,message:n,payload:r},i};